<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSTR1 CSV Processor - Multi Format</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; --success: #10b981;
            --danger: #ef4444; --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
            --text-light: #64748b; --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 2rem; color: var(--text);
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 3rem; color: white; }
        .header h1 {
            font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;
            font-family: 'Space Mono', monospace; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .header p { font-size: 1.1rem; opacity: 0.95; }
        .header .badge {
            display: inline-block; background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem; border-radius: 20px; margin-top: 1rem; font-size: 0.9rem;
        }
        .main-card {
            background: var(--card); border-radius: 20px; padding: 2.5rem;
            box-shadow: var(--shadow-lg); animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step { margin-bottom: 2rem; }
        .step-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .step-number {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-weight: 700; font-family: 'Space Mono', monospace;
            box-shadow: var(--shadow);
        }
        .step-title { font-size: 1.25rem; font-weight: 700; color: var(--text); }
        
        .format-selector {
            display: flex; gap: 1rem; margin-bottom: 1.5rem;
        }
        .format-option {
            flex: 1; padding: 1.5rem; border-radius: 12px; border: 2px solid var(--border);
            background: var(--bg); cursor: pointer; transition: all 0.3s ease;
            text-align: center;
        }
        .format-option:hover {
            border-color: var(--primary); transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .format-option.active {
            border-color: var(--primary); background: rgba(37, 99, 235, 0.1);
            box-shadow: var(--shadow);
        }
        .format-option .format-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .format-option .format-name { font-weight: 700; font-size: 1.1rem; color: var(--text); }
        .format-option .format-desc { font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem; }
        
        .upload-zone {
            border: 3px dashed var(--border); border-radius: 15px; padding: 3rem 2rem;
            text-align: center; background: var(--bg); transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-zone:hover { border-color: var(--primary); background: rgba(37, 99, 235, 0.05); }
        .upload-zone.dragover { border-color: var(--primary); background: rgba(37, 99, 235, 0.1); transform: scale(1.02); }
        .upload-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.6; }
        .upload-text { font-size: 1.1rem; color: var(--text); margin-bottom: 0.5rem; }
        .upload-hint { font-size: 0.9rem; color: var(--text-light); }
        input[type="file"] { display: none; }
        .file-list {
            margin-top: 1.5rem; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;
        }
        .file-item {
            background: var(--bg); padding: 1rem; border-radius: 10px;
            display: flex; align-items: center; gap: 0.75rem; border: 1px solid var(--border);
            transition: all 0.2s ease; animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .file-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .file-icon { font-size: 1.5rem; }
        .file-info { flex: 1; min-width: 0; }
        .file-name {
            font-weight: 600; font-size: 0.9rem; color: var(--text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .file-size { font-size: 0.75rem; color: var(--text-light); }
        .file-remove {
            background: none; border: none; color: var(--danger); cursor: pointer;
            font-size: 1.2rem; padding: 0.25rem; border-radius: 5px; transition: all 0.2s ease;
        }
        .file-remove:hover { background: rgba(239, 68, 68, 0.1); }
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border: none; padding: 1rem 2.5rem; font-size: 1.1rem;
            font-weight: 700; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: var(--shadow); font-family: 'Space Mono', monospace;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-container { text-align: center; margin-top: 2rem; }
        .status {
            margin-top: 1.5rem; padding: 1rem; border-radius: 10px;
            display: none; animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status.success { background: rgba(16, 185, 129, 0.1); border: 2px solid var(--success); color: var(--success); display: block; }
        .status.error { background: rgba(239, 68, 68, 0.1); border: 2px solid var(--danger); color: var(--danger); display: block; }
        .status.info { background: rgba(37, 99, 235, 0.1); border: 2px solid var(--primary); color: var(--primary); display: block; }
        .progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 10px; overflow: hidden; margin-top: 1rem; display: none; }
        .progress-bar.active { display: block; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; transition: width 0.3s ease; border-radius: 10px; }
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .header h1 { font-size: 1.75rem; }
            .main-card { padding: 1.5rem; }
            .file-list { grid-template-columns: 1fr; }
            .format-selector { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä GSTR1 CSV Processor</h1>
            <p>Supports Standard & Tally Excel formats!</p>
            <div class="badge">‚ú® Date Fix Applied - 2026 Working!</div>
        </div>
        <div class="main-card">
            <div class="step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Select Input Format</div>
                </div>
                <div class="format-selector">
                    <div class="format-option active" id="standardFormat" onclick="selectFormat('standard')">
                        <div class="format-icon">üìã</div>
                        <div class="format-name">Standard Format</div>
                        <div class="format-desc">Default GSTR CSV files</div>
                    </div>
                    <div class="format-option" id="tallyFormat" onclick="selectFormat('tally')">
                        <div class="format-icon">üíº</div>
                        <div class="format-name">Tally Excel</div>
                        <div class="format-desc">Tally exported CSV files</div>
                    </div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Upload CSV Files</div>
                </div>
                <div class="upload-zone" id="csvZone" onclick="document.getElementById('csvInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Click or drag your CSV files here</div>
                    <div class="upload-hint">Select all CSV files at once</div>
                </div>
                <input type="file" id="csvInput" accept=".csv" multiple />
                <div class="file-list" id="csvList"></div>
            </div>
            
            <div class="step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Process & Download</div>
                </div>
                <div class="btn-container">
                    <button class="btn" id="mergeBtn" disabled onclick="mergeFiles()">üöÄ Process & Download</button>
                </div>
                <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="status" id="status"></div>
            </div>
        </div>
    </div>
    <script>
        const EMBEDDED_TEMPLATE_BASE64 = `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`;
        let csvFiles = {};
        let selectedFormat = 'standard';
        
        function selectFormat(format) {
            selectedFormat = format;
            document.getElementById('standardFormat').classList.remove('active');
            document.getElementById('tallyFormat').classList.remove('active');
            document.getElementById(format + 'Format').classList.add('active');
        }
        
        function cleanPlaceOfSupply(value) {
            if (!value) return '';
            return value.toString().trim().replace(/^\d+-\s*/, '').trim();
        }
        function trimAllFields(obj) {
            const cleaned = {};
            for (const [key, value] of Object.entries(obj)) {
                cleaned[key] = typeof value === 'string' ? value.trim() : value;
            }
            return cleaned;
        }
        function processDocsIssued(data) {
            return data.map(row => {
                const cleaned = trimAllFields(row);
                const totalNumber = parseFloat(cleaned['Total Number']) || 0;
                const cancelled = parseFloat(cleaned['Cancelled']) || 0;
                return {
                    'Nature of Document': cleaned['Nature of Document'] || cleaned['Type of Document'] || '',
                    'Sr.No.From': cleaned['Sr.No.From'] || cleaned['Sr. No. From'] || cleaned['Series From'] || '',
                    'Sr.No.To': cleaned['Sr.No.To'] || cleaned['Sr. No. To'] || cleaned['Series To'] || '',
                    'Total Number': totalNumber,
                    'Cancelled': cancelled,
                    'Net Issued': totalNumber - cancelled
                };
            });
        }
        function processHSNData(data, fileName) {
            const isB2B = fileName.toUpperCase().includes('B2B');
            const isB2C = fileName.toUpperCase().includes('B2C');
            return data.map(row => {
                const cleaned = trimAllFields(row);
                if (isB2B) cleaned['Type'] = 'B2B';
                else if (isB2C) cleaned['Type'] = 'B2C';
                if (!cleaned['Rate'] || cleaned['Rate'] === '') cleaned['Rate'] = 0;
                return cleaned;
            });
        }
        
        // Standard format mappings (existing)
        const standardMappings = {
            'b2b': {
                'GSTIN/UIN of Recipient': 'GSTIN/UIN',
                'Invoice Number': 'Invoice No',
                'Invoice date': 'Date of Invoice',
                'Invoice Value': 'Invoice Value',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS',
                'Place Of Supply': 'Place Of Supply',
                'Reverse Charge': 'RCM Applicable',
                'Invoice Type': 'Invoice Type',
                'E-Commerce GSTIN': 'E-Commerce GSTIN'
            },
            'b2cl': {
                'Invoice Number': 'Invoice No',
                'Invoice date': 'Date of Invoice',
                'Invoice Value': 'Invoice Value',
                'Place Of Supply': 'Place Of Supply',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS',
                'E-Commerce GSTIN': 'E-Commerce GSTIN'
            },
            'b2cs': {
                'Type': 'Type',
                'Place Of Supply': 'Place Of Supply',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS',
                'E-Commerce GSTIN': 'E-Commerce GSTIN'
            },
            'export': {
                'Export Type': 'Export Type',
                'Invoice Number': 'Invoice No',
                'Invoice date': 'Date of Invoice',
                'Invoice Value': 'Invoice Value',
                'Port Code': 'Port Code',
                'Shipping Bill Number': 'Shipping Bill No',
                'Shipping Bill Date': 'Shipping Bill Date',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value'
            },
            'Nil_exempt_NonGST': {
                'Description': 'Description',
                'Nil Rated Supplies': 'Nil Rated Supplies',
                'Exempted (other than nil rated/non GST supply)': 'Exempted(other than nil rated/non GST supply)',
                'Non-GST supplies': 'Non-GST Supplies'
            },
            'cdnr': {
                'GSTIN/UIN of Recipient': 'GSTIN/UIN',
                'Note Number': 'Dr./ Cr. No.',
                'Note Date': 'Dr./Cr. Date',
                'Note Type': 'Type of note                (Dr/ Cr)',
                'Place Of Supply': 'Place of supply',
                'Reverse Charge': 'RCM',
                'Note Supply Type': 'Invoice Type',
                'Note Value': 'Dr./Cr. Value',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS'
            },
            'cdnur': {
                'UR Type': 'Supply Type',
                'Note/Refund Voucher Number': 'Dr./ Cr. Note No.',
                'Note/Refund Voucher date': 'Dr./ Cr. Note Date',
                'Document Type': 'Type of note (Dr./ Cr.)',
                'Place Of Supply': 'Place of supply',
                'Note/Refund Voucher Value': 'Dr./Cr. Note Value',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS'
            },
            'adv_tax': {
                'Place Of Supply': 'Place Of Supply',
                'Rate': 'GST%',
                'Gross Advance Received': 'Gross Advance Received',
                'Cess Amount': 'CESS'
            },
            'adv_tax_adjusted': {
                'Place Of Supply': 'Place Of Supply',
                'Rate': 'GST%',
                'Gross Advance Adjusted': 'Gross Advance Adjusted',
                'Cess Amount': 'CESS'
            },
            'Docs_issued': {
                'Nature of Document': ['Nature of Document', 'Type of Document'],
                'Sr.No.From': ['Sr.No.From', 'Series From'],
                'Sr.No.To': ['Sr.No.To', 'Series To'],
                'Total Number': ['Total Number'],
                'Cancelled': ['Cancelled'],
                'Net Issued': ['Net Issued']
            },
            'hsn': {
                'Type': 'Type',
                'HSN': 'HSN',
                'Description': 'Description',
                'UQC': 'UQC',
                'Total Quantity': 'Total Quantity',
                'Total Value': 'Total Value',
                'Rate': 'Rate',
                'Taxable Value': 'Total Taxable Value',
                'Integrated Tax Amount': 'IGST',
                'Central Tax Amount': 'CGST',
                'State/UT Tax Amount': 'SGST',
                'Cess Amount': 'CESS'
            }
        };
        
        // Tally format mappings (same as standard, just for clarity)
        const tallyMappings = {
            'b2b': {
                'GSTIN/UIN of Recipient': 'GSTIN/UIN',
                'Invoice Number': 'Invoice No',
                'Invoice date': 'Date of Invoice',
                'Invoice Value': 'Invoice Value',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS',
                'Place Of Supply': 'Place Of Supply',
                'Reverse Charge': 'RCM Applicable',
                'Invoice Type': 'Invoice Type',
                'E-Commerce GSTIN': 'E-Commerce GSTIN'
            },
            'b2cl': {
                'Invoice Number': 'Invoice No',
                'Invoice date': 'Date of Invoice',
                'Invoice Value': 'Invoice Value',
                'Place Of Supply': 'Place Of Supply',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS',
                'E-Commerce GSTIN': 'E-Commerce GSTIN'
            },
            'b2cs': {
                'Type': 'Type',
                'Place Of Supply': 'Place Of Supply',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS',
                'E-Commerce GSTIN': 'E-Commerce GSTIN'
            },
            'export': {
                'Export Type': 'Export Type',
                'Invoice Number': 'Invoice No',
                'Invoice date': 'Date of Invoice',
                'Invoice Value': 'Invoice Value',
                'Port Code': 'Port Code',
                'Shipping Bill Number': 'Shipping Bill No',
                'Shipping Bill Date': 'Shipping Bill Date',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value'
            },
            'Nil_exempt_NonGST': {
                'Description': 'Description',
                'Nil Rated Supplies': 'Nil Rated Supplies',
                'Exempted (other than nil rated/non GST supply)': 'Exempted(other than nil rated/non GST supply)',
                'Non-GST supplies': 'Non-GST Supplies'
            },
            'cdnr': {
                'GSTIN/UIN of Recipient': 'GSTIN/UIN',
                'Note Number': 'Dr./ Cr. No.',
                'Note Date': 'Dr./Cr. Date',
                'Note Type': 'Type of note                (Dr/ Cr)',
                'Place Of Supply': 'Place of supply',
                'Reverse Charge': 'RCM',
                'Note Supply Type': 'Invoice Type',
                'Note Value': 'Dr./Cr. Value',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS'
            },
            'cdnur': {
                'UR Type': 'Supply Type',
                'Note/Refund Voucher Number': 'Dr./ Cr. Note No.',
                'Note/Refund Voucher date': 'Dr./ Cr. Note Date',
                'Document Type': 'Type of note (Dr./ Cr.)',
                'Place Of Supply': 'Place of supply',
                'Note/Refund Voucher Value': 'Dr./Cr. Note Value',
                'Rate': 'GST%',
                'Taxable Value': 'Taxable Value',
                'Cess Amount': 'CESS'
            },
            'adv_tax': {
                'Place Of Supply': 'Place Of Supply',
                'Rate': 'GST%',
                'Gross Advance Received': 'Gross Advance Received',
                'Cess Amount': 'CESS'
            },
            'adv_tax_adjusted': {
                'Place Of Supply': 'Place Of Supply',
                'Rate': 'GST%',
                'Gross Advance Adjusted': 'Gross Advance Adjusted',
                'Cess Amount': 'CESS'
            },
            'Docs_issued': {
                'Nature of Document': ['Nature of Document', 'Type of Document'],
                'Sr.No.From': ['Sr.No.From', 'Sr. No. From', 'Series From'],
                'Sr.No.To': ['Sr.No.To', 'Sr. No. To', 'Series To'],
                'Total Number': ['Total Number'],
                'Cancelled': ['Cancelled'],
                'Net Issued': ['Net Issued']
            },
            'hsn': {
                'Type': 'Type',
                'HSN': 'HSN',
                'Description': 'Description',
                'UQC': 'UQC',
                'Total Quantity': 'Total Quantity',
                'Total Value': 'Total Value',
                'Rate': 'Rate',
                'Taxable Value': 'Total Taxable Value',
                'Integrated Tax Amount': 'IGST',
                'Central Tax Amount': 'CGST',
                'State/UT Tax Amount': 'SGST',
                'Cess Amount': 'CESS'
            }
        };
        
        function getSheetNameFromFile(fileName) {
            const upper = fileName.toUpperCase();
            if (upper.includes('HSN')) return 'hsn';
            if (upper.includes('B2B')) return 'b2b';
            if (upper.includes('B2CL')) return 'b2cl';
            if (upper.includes('B2CS')) return 'b2cs';
            if (upper.includes('EXP')) return 'export';
            if (upper.includes('EXEMP')) return 'Nil_exempt_NonGST';
            if (upper.includes('CDNR') && !upper.includes('CDNUR')) return 'cdnr';
            if (upper.includes('CDNUR')) return 'cdnur';
            if (upper.includes('ATADJ')) return 'adv_tax_adjusted';
            if (upper.includes('AT') && !upper.includes('ATADJ')) return 'adv_tax';
            if (upper.includes('DOC')) return 'Docs_issued';
            return null;
        }
        
        function setupDragDrop(zoneId, inputId) {
            const zone = document.getElementById(zoneId);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.add('dragover'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.remove('dragover'), false);
            });
            zone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                document.getElementById(inputId).files = files;
                handleFileSelect(inputId);
            }, false);
        }
        setupDragDrop('csvZone', 'csvInput');
        document.getElementById('csvInput').addEventListener('change', () => handleFileSelect('csvInput'));
        
        function handleFileSelect(inputId) {
            const input = document.getElementById(inputId);
            const files = Array.from(input.files);
            files.forEach(file => {
                const fileName = file.name.toUpperCase();
                csvFiles[fileName] = file;
            });
            displayCsvFiles();
            updateMergeButton();
        }
        function displayCsvFiles() {
            const list = document.getElementById('csvList');
            const fileNames = Object.keys(csvFiles);
            if (fileNames.length === 0) {
                list.innerHTML = '';
                return;
            }
            list.innerHTML = fileNames.map(fileName => `
                <div class="file-item">
                    <div class="file-icon">üìä</div>
                    <div class="file-info">
                        <div class="file-name">${fileName}</div>
                        <div class="file-size">${formatFileSize(csvFiles[fileName].size)}</div>
                    </div>
                    <button class="file-remove" onclick="removeCsv('${fileName}')">√ó</button>
                </div>
            `).join('');
        }
        function removeCsv(fileName) {
            delete csvFiles[fileName];
            displayCsvFiles();
            updateMergeButton();
        }
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        function updateMergeButton() {
            const btn = document.getElementById('mergeBtn');
            btn.disabled = Object.keys(csvFiles).length === 0;
        }
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        function updateProgress(percent) {
            document.getElementById('progressBar').classList.add('active');
            document.getElementById('progressFill').style.width = percent + '%';
        }
        function hideProgress() {
            document.getElementById('progressBar').classList.remove('active');
            document.getElementById('progressFill').style.width = '0%';
        }
        async function mergeFiles() {
            try {
                showStatus(`Loading template (${selectedFormat} format)...`, 'info');
                updateProgress(10);
                const templateBinary = Uint8Array.from(atob(EMBEDDED_TEMPLATE_BASE64.trim()), c => c.charCodeAt(0));
                const workbook = XLSX.read(templateBinary, { type: 'array', cellStyles: true });
                
                // Select the correct mappings based on format
                const columnMappings = selectedFormat === 'tally' ? tallyMappings : standardMappings;
                
                updateProgress(30);
                showStatus('Processing CSV files...', 'info');
                let processed = 0;
                const totalCsvs = Object.keys(csvFiles).length;
                for (const [fileName, file] of Object.entries(csvFiles)) {
                    const sheetName = getSheetNameFromFile(fileName);
                    if (!sheetName) continue;
                    const csvText = await readFileAsText(file);
                    let csvData = parseCSV(csvText);
                    if (csvData.length === 0) continue;
                    if (fileName.includes('DOC')) {
                        csvData = processDocsIssued(csvData);
                    } else if (fileName.includes('HSN')) {
                        csvData = processHSNData(csvData, fileName);
                    } else {
                        csvData = csvData.map(row => trimAllFields(row));
                    }
                    const sheet = workbook.Sheets[sheetName];
                    if (!sheet) continue;
                    const mapping = columnMappings[sheetName] || {};
                    if (sheetName === 'Nil_exempt_NonGST') {
                        updateExemptSheet(sheet, csvData, mapping, sheetName);
                    } else {
                        appendDataToSheetWithMapping(sheet, csvData, mapping, sheetName);
                    }
                    processed++;
                    updateProgress(30 + (processed / totalCsvs) * 50);
                }
                updateProgress(85);
                showStatus('Generating Excel...', 'info');
                const outputData = XLSX.write(workbook, { bookType: 'xlsx', type: 'array', cellStyles: true });
                updateProgress(95);
                const blob = new Blob([outputData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                saveAs(blob, `GSTR1_${selectedFormat}_${timestamp}.xlsx`);
                updateProgress(100);
                showStatus('‚úÖ Success! File downloaded.', 'success');
                setTimeout(hideProgress, 2000);
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error: ' + error.message, 'error');
                hideProgress();
            }
        }
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length <= 1) return [];
            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }
            const headers = parseLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            return data;
        }
        function updateExemptSheet(sheet, data, columnMapping, sheetName) {
            if (data.length === 0) return;
            const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
            const templateHeaders = [];
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddr = XLSX.utils.encode_cell({ r: 0, c: col });
                const cell = sheet[cellAddr];
                templateHeaders.push(cell && cell.v ? cell.v.toString().trim() : '');
            }
            data.forEach((csvRow) => {
                const csvDesc = (csvRow['Description'] || '').toString().trim();
                for (let row = 1; row <= range.e.r; row++) {
                    const descCell = sheet[XLSX.utils.encode_cell({ r: row, c: 0 })];
                    const templateDesc = descCell && descCell.v ? descCell.v.toString().trim() : '';
                    if (templateDesc === csvDesc) {
                        templateHeaders.forEach((templateHeader, colIndex) => {
                            if (!templateHeader || colIndex === 0) return;
                            let csvValue = '';
                            if (csvRow[templateHeader] !== undefined) {
                                csvValue = csvRow[templateHeader];
                            } else {
                                for (const [csvCol, excelCol] of Object.entries(columnMapping)) {
                                    const excelCols = Array.isArray(excelCol) ? excelCol : [excelCol];
                                    if (excelCols.includes(templateHeader) && csvRow[csvCol] !== undefined) {
                                        csvValue = csvRow[csvCol];
                                        break;
                                    }
                                }
                            }
                            const cellAddr = XLSX.utils.encode_cell({ r: row, c: colIndex });
                            if (!csvValue && csvValue !== 0) {
                                sheet[cellAddr] = { t: 'n', v: 0 };
                                return;
                            }
                            const numValue = parseFloat(csvValue.toString().replace(/,/g, ''));
                            if (!isNaN(numValue)) {
                                sheet[cellAddr] = { t: 'n', v: numValue };
                            } else {
                                sheet[cellAddr] = { t: 's', v: csvValue.toString().trim() };
                            }
                        });
                        break;
                    }
                }
            });
        }
        function appendDataToSheetWithMapping(sheet, data, columnMapping, sheetName) {
            if (data.length === 0) return;
            const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
            const templateHeaders = [];
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddr = XLSX.utils.encode_cell({ r: 0, c: col });
                const cell = sheet[cellAddr];
                templateHeaders.push(cell && cell.v ? cell.v.toString().trim() : '');
            }
            let startRow = 1;
            let lastRowWithData = 0;
            for (let row = 1; row <= range.e.r; row++) {
                let hasData = false;
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddr = XLSX.utils.encode_cell({ r: row, c: col });
                    const cell = sheet[cellAddr];
                    if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') {
                        hasData = true;
                        break;
                    }
                }
                if (hasData) lastRowWithData = row;
            }
            if (lastRowWithData > 0) startRow = lastRowWithData + 1;
            data.forEach((csvRow, rowIndex) => {
                const excelRowNum = startRow + rowIndex;
                templateHeaders.forEach((templateHeader, colIndex) => {
                    if (!templateHeader) return;
                    let csvValue = '';
                    if (csvRow[templateHeader] !== undefined) {
                        csvValue = csvRow[templateHeader];
                    } else {
                        for (const [csvCol, excelCol] of Object.entries(columnMapping)) {
                            const excelCols = Array.isArray(excelCol) ? excelCol : [excelCol];
                            if (excelCols.includes(templateHeader) && csvRow[csvCol] !== undefined) {
                                csvValue = csvRow[csvCol];
                                break;
                            }
                        }
                    }
                    const cellAddr = XLSX.utils.encode_cell({ r: excelRowNum, c: colIndex });
                    if (!csvValue && csvValue !== 0) {
                        sheet[cellAddr] = { t: 's', v: '' };
                        return;
                    }
                    let finalValue = csvValue;
                    if (templateHeader.toLowerCase().includes('place of supply')) {
                        finalValue = cleanPlaceOfSupply(csvValue);
                    }
                    if (templateHeader === 'Invoice Type') {
                        finalValue = csvValue.toString().replace(' B2B', '').replace(' B2C', '').trim();
                    }
                    if (templateHeader === 'RCM Applicable' || templateHeader === 'RCM') {
                        finalValue = csvValue === 'Y' ? 'Yes' : csvValue === 'N' ? 'No' : csvValue;
                    }
                    if (templateHeader === 'Rate' || templateHeader === 'GST%') {
                        if (!csvValue || csvValue === '') finalValue = 0;
                    }
                    if (templateHeader.toLowerCase().includes('date')) {
                        // FIXED: Now handles both DD-MMM-YY and DD-MMM-YYYY formats
                        const dateMatch = csvValue.toString().match(/(\d{1,2})-([A-Za-z]{3})-(\d{2,4})/);
                        if (dateMatch) {
                            const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
                            const day = parseInt(dateMatch[1]);
                            const month = months[dateMatch[2]];
                            let year = parseInt(dateMatch[3]);
                            
                            // If 2-digit year, add 2000; if 4-digit year, use as-is
                            if (year < 100) {
                                year = 2000 + year;
                            }
                            
                            const dayStr = day.toString().padStart(2, '0');
                            const monthStr = (month + 1).toString().padStart(2, '0');
                            finalValue = `${dayStr}-${monthStr}-${year}`;
                        }
                    }
                    const numValue = parseFloat(finalValue.toString().replace(/,/g, ''));
                    if (!isNaN(numValue) && finalValue.toString().match(/^-?\d+\.?\d*$/)) {
                        sheet[cellAddr] = { t: 'n', v: numValue };
                    } else {
                        sheet[cellAddr] = { t: 's', v: finalValue.toString().trim() };
                    }
                });
            });
            range.e.r = startRow + data.length - 1;
            sheet['!ref'] = XLSX.utils.encode_range(range);
        }
    </script>
</body>
</html>
